{% extends "layout.html" %}

{% block content %}

    <h2>Analysis</h2>

    <div class = "grid-top">

        <div class ="card">
            <div class = "card-header">
                <h3>Average Transaction</h3>
            </div>
            <div class="card-body">
                <i class="fa-solid fa-database icon red"></i>
                <p>{{ avg_amount }}</p>
            </div>
        </div>

        <div class ="card">
            <div class = "card-header">
                <h3>Median Transaction</h3>
            </div>
            <div class="card-body">
                <i class="fa-solid fa-circle-check icon green"></i>
                <p>{{ median_amount }}</p>
            </div>
        </div>

        <div class ="card">
            <div class = "card-header">
                <h3>Standard Deviation</h3>
            </div>
            <div class="card-body">
                <i class="fa-solid fa-triangle-exclamation icon orange"></i>
                <p>{{ std_dev_amount }}</p>
            </div>
        </div>

        <div class ="card">
            <div class = "card-header">
                <h3>Amount Volatility (CV)</h3>
            </div>
            <div class="card-body">
                <i class="fa-solid fa-percent icon blue"></i>
                <p>{{ cof_var }}</p>
            </div>
        </div>
    </div>

    <div class ="grid-mid-analytics">
        <div class="card chart-card">
            <div class="card-header">
                <h3>Transactions Over Time</h3>
            </div>
            <div class="card-body chart-body">
                <div class="line-chart-wrap">
                <canvas id="transactionsLine"></canvas>
                </div>
            </div>
        </div>
        <div class="card">
            <div class="card-header">
                <h3>Amount Distribution (By Category Amounts)</h3>
            </div>

            <div class="donut-wrap">
                <div class="donut-chart">
                    <canvas id="amountDistDonut"></canvas>
                </div>

                <div class="donut-stats">
                <div class="stat red">
                    <span class="dot"></span>
                    <div>
                        <div class="value">&lt; $10</div>
                    </div>
                </div>

                <div class="stat orange">
                    <span class="dot"></span>
                    <div>
                        <div class="value">$10–$50</div>
                    </div>
                </div>

                <div class="stat blue">
                    <span class="dot"></span>
                    <div>
                        <div class="value">$50–$200</div>
                    </div>
                </div>

                <div class="stat green">
                    <span class="dot"></span>
                    <div>
                        <div class="value">$200+</div>
                    </div>
                </div>
                </div>
            </div>
        </div>
    </div>
    

    <div class = "grid-bottom">


        <div class = "card aggregate-main">
            <div class = "card-header">
                <h3>Category Amount Share</h3>
            </div>

            <div class = "category-bars">
                <canvas id = "categoryAmountBar"></canvas>
            </div>
        </div>

        <div class="card category-card">
            <div class="card-header">
                <h3>Status by Category</h3>
            </div>

            <div class = "status-table-wrap">
                <table class = "status-table">
                    <thead>
                        <tr>
                            <th>Category</th>
                            <th class = "Completed">Completed</th>
                            <th class = "Pending">Pending</th>
                            <th class = "Error">Error</th>
                        </tr>
                    </thead>

                    <tbody>
                    {% for cat, values in status_by_category.items() %}
                    <tr>
                        <td class="category">{{ cat }}</td>

                        <td class="cell completed">
                        {{ values["Completed"] }}
                        </td>

                        <td class="cell pending">
                        {{ values["Pending"] }}
                        </td>

                        <td class="cell error">
                        {{ values["Error"] }}
                        </td>
                    </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        
        <div class = "card">
            <div class="card-header">
                <h3>Data Shape Summary</h3>
            </div>

            <div class = "data-shape">
                <div class = "row">
                    <span>Min Amount</span>
                    <span>${{ "%.2f"|format(min_amount) }}</span>
                </div>

                <div class = "row">
                    <span>Max Amount</span>
                    <span>${{ "%.2f"|format(max_amount) }}</span>
                </div>

                <div class = "row">
                    <span>Amount Range</span>
                    <span>${{ "%.2f"|format(amount_range) }}</span>
                </div>

                <div class = "row">
                    <span>Unique Categories</span>
                    <span>{{ unique_categories }}</span>
                </div>

                <div class = "row">
                    <span>Unique Statuses</span>
                    <span>{{ unique_statuses }}</span>
                </div>
            </div>
            
        </div>

    </div>


{% endblock %}



{% block scripts %}

<script>
const allLabels = {{ dates | tojson }};
const allData = {{ daily_counts | tojson }};

// how many points visible initially
const INITIAL_POINTS = 10;

// clamp in case dataset is small
const startIndex = 0;
const endIndex = Math.min(INITIAL_POINTS - 1, allLabels.length - 1);
</script>


<script>
const txCtx = document.getElementById("transactionsLine");

new Chart(txCtx, {
  type: 'line',
  data: {
    labels: {{ dates | tojson }},
    datasets: [{
      label: 'Transactions',
      data: {{ daily_counts | tojson }},
      borderColor: '#3b82f6',
      backgroundColor: 'rgba(59,130,246,0.18)',
      tension: 0.25,                 // slightly less smoothing = more detail
      fill: true,
      pointRadius: 4,                // slightly smaller = less visual noise
      pointHoverRadius: 6,
      pointBackgroundColor: '#93c5fd',
      pointBorderWidth: 0
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,

    layout: {
      padding: { top: 12, right: 20, bottom: 10, left: 10 }
    },

    plugins: {
      legend: { display: false },

      tooltip: {
        backgroundColor: '#1f2937',
        titleColor: '#fff',
        bodyColor: '#e5e7eb',
        displayColors: false
      },

      zoom: {
        pan: {
          enabled: true,
          mode: 'x'
        },
        zoom: {
          wheel: { enabled: true },
          pinch: { enabled: true },
          mode: 'x'
        }
      }
    },

    scales: {
      x: {
        type: 'category',
        min: startIndex,
        max: endIndex,

        ticks: {
          color: '#cbd5e1',          // keeps labels clean
          autoSkip: true
        },
        grid: { display: false },
        border: { display: false }
      },
      y: {
        ticks: { color: '#cbd5e1' },
        grid: { color: '#3f4452' },
        border: { display: false }
      }
    }
  }
});
</script>



<script>
    const centerTextPlugin = {
        id: 'centerText',
        afterDraw(chart) {
            const { ctx } = chart;
            const meta = chart.getDatasetMeta(0);
            if (!meta?.data?.length) return;

            const values = chart.data.datasets[0].data;
            const total = values.reduce((a, b) => a + b, 0);
            const max = Math.max(...values);
            const pct = ((max / total) * 100).toFixed(1);

            const { x, y } = meta.data[0];

            ctx.save();
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';

            ctx.font = '1000 40px system-ui';
            ctx.fillStyle = '#ffffff';
            ctx.fillText(max, x, y - 10);

            ctx.font = '800 20px system-ui';
            ctx.fillStyle = '#cbd5e1';
            ctx.fillText(`${pct}%`, x, y + 16);

            ctx.restore();
        }
    };

const statusCtx = document.getElementById('amountDistDonut');

new Chart(statusCtx, {
  type: 'doughnut',
  data: {
    labels: ['< $10', '$10–$50', '$50–$200', '$200+'],
    datasets: [{
        data: [
        {{ buckets["<10"] }},
        {{ buckets["10-50"] }},
        {{ buckets["50-200"] }},
        {{ buckets["200+"] }}
      ],

        backgroundColor: [
        '#ef4444',
        '#f97316',
        '#3b82f6',
        '#22c55e'
      ],
      borderWidth: 0
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    cutout: '70%',
    plugins: {
      legend: { display: false },   
      datalabels: { display: false } 
    }
  },
  plugins: [centerTextPlugin]
});

</script>


<script>
    const catAmountCtx = document.getElementById('categoryAmountBar')

    new Chart(catAmountCtx, {
  type: 'bar',
  data: {
    labels: {{ category_amounts.keys() | list | tojson }},
    datasets: [{
      data: {{ category_amounts.values() | list | tojson }},
      backgroundColor: [
        '#22c55e',
        '#3b82f6',
        '#a855f7',
        '#ef4444',
        '#f97316'
      ],
      borderRadius: 10,
      barThickness: 18
    }]
  },
  options: {
    indexAxis: 'y',
    responsive: true,
    maintainAspectRatio: false,
    clip: false,
    layout: {
      padding: { right: 110 }
    },
    plugins: {
      legend: { display: false },
      datalabels: {
        clip: false,
        anchor: 'end',
        align: 'right',
        offset: 8,
        color: '#e5e7eb',
        font: {
          weight: '700',
          size: 15
        },
        formatter: v => `$${v.toLocaleString()}`
      }
    },
    scales: {
      x: {
        ticks: { display: false },
        grid: { display: false },
        border: { display: false }
      },
      y: {
        ticks: { color: '#e5e7eb', 
                    font: {
            size: 13,        
            weight: '300'   
            }
        },
        grid: { display: false },
        border: { display: false }
      }
    }
  },
  plugins: [ChartDataLabels]   // ← THIS IS NON-OPTIONAL
});
</script>
{% endblock %}
